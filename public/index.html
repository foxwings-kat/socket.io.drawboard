<!DOCTYPE html>
<html>

<head>
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>Socket.IO chat</title>
	<style>
		.roomNumDiv {
			background-color: lightblue;
			text-align: center;
		}

		body {
			margin: 0;
			padding-bottom: 3rem;
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
		}

		#form {
			background: rgba(0, 0, 0, 0.15);
			padding: 0.25rem;
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			display: flex;
			height: 3rem;
			box-sizing: border-box;
			backdrop-filter: blur(10px);
		}

		#input {
			border: none;
			padding: 0 1rem;
			flex-grow: 1;
			border-radius: 2rem;
			margin: 0.25rem;
		}

		#input:focus {
			outline: none;
		}

		#form>button {
			background: #333;
			border: none;
			padding: 0 1rem;
			margin: 0.25rem;
			border-radius: 3px;
			outline: none;
			color: #fff;
		}

		#messages {
			list-style-type: none;
			margin: 0;
			padding: 0;
		}

		#messages>li {
			padding: 0.5rem 1rem;
		}

		#messages>li:nth-child(odd) {
			background: #efefef;
		}

		#board {
			margin: 0 auto;
			width: 500px;
		}

		#myCanvas {
			border: 3px dotted #000;
		}
	</style>
</head>

<body>
	<form id="form" action="">
		<input id="input" autocomplete="off" /><button>Send</button>
	</form>
	<div class="roomNumDiv">
		<button type="button" id="creatNewRoomBTN">Creat a New Room</button>
		<form id="joinNewRoomForm" action="">
			<input type="text" id="joinNewRoomInput" name="fname" placeholder="enter Room code">
		</form>
	</div>

	<div id="board">
		<canvas id="myCanvas" width="500px" height="500px">
			Sorry, your browser doesn't support canvas technology.
		</canvas>
		<p>Color picker: <select id="selectColor">
				<option id="colBlack" value="black" selected="selected">Black</option>
				<option id="colRed" value="red">Red</option>
				<option id="colBlue" value="blue">Blue</option>
				<option id="colGreen" value="green">Green</option>
				<option id="colOrange" value="orange">Orange</option>
				<option id="colYellow" value="yellow">Yellow</option>
			</select>
			<button type="button" id="drawBTN">I want to DRAW</button>
		</p>
	</div><!-- END board -->

	<ul id="messages"></ul>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var roomNumber;

		function generateRandomString(length) {
			const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
			let randomString = '';

			for (let i = 0; i < length; i++) {
				const randomIndex = Math.floor(Math.random() * characters.length);
				randomString += characters.charAt(randomIndex);
			}

			return randomString;
		}

		const userTag = generateRandomString(6);
		var socket = io();

		var joinNewRoomForm = document.getElementById('joinNewRoomForm');
		var joinNewRoomInput = document.getElementById('joinNewRoomInput');
		var creatNewRoomBTN = document.getElementById('creatNewRoomBTN');
		var input = document.getElementById('input');

		var form = document.getElementById('form');
		var messages = document.getElementById('messages');

		form.addEventListener('submit', function (e) {
			e.preventDefault();
			if (input.value) {
				let msg = {
					"msg": input.value,
					"roomNumber": roomNumber,
				}
				socket.emit('chat message', msg);
				input.value = '';
			}
		});

		joinNewRoomForm.addEventListener('submit', function (e) {
			e.preventDefault();
			if (joinNewRoomInput.value) {
				socket.emit('leave_room', roomNumber);
				roomNumber = joinNewRoomInput.value;
				socket.emit('join_room', roomNumber);
			}
		});

		creatNewRoomBTN.addEventListener('click', function (e) {
			socket.emit('leave_room', roomNumber);
			roomNumber = generateRandomString(6);
			joinNewRoomInput.value = roomNumber;
			socket.emit('join_room', roomNumber);
		});

		socket.on('chat message', function (msg) {
			var item = document.createElement('li');
			item.textContent = msg;
			messages.appendChild(item);
			window.scrollTo(0, document.body.scrollHeight);
		});	
	</script>

	<!-- board Script -->
	<script type="text/JavaScript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js?ver=1.4.2">
    </script>
	<script type="text/javascript">
		var turn_to_draw = false;
		var drawBTN = document.getElementById('drawBTN');

		drawBTN.addEventListener('click', function (e) {
			let data = {
				"roomNumber": roomNumber,
				"whoWantToDraw": socket.id,
			}
			socket.emit('turn_to_draw', data);

			turn_to_draw = true;

			drawBTN.innerHTML = "you're drawing now";
		});

		socket.on('turn_to_draw', function (data) {
			console.log('drawing now: ' + data.whoWantToDraw);
			if (data.whoWantToDraw != socket.id) {
				turn_to_draw = false;
				drawBTN.innerHTML = "I want to DRAW";
			}
		});

		var canvas = document.getElementById("myCanvas");
		var curColor = $('#selectColor option:selected').val();
		var context = myCanvas.getContext("2d");
		var drawing = false;

		$('#selectColor').change(function () {
			curColor = $('#selectColor option:selected').val();
		});

		var current = {
			color: 'black'
		};

		canvas.addEventListener('mousedown', onMouseDown, false);
		canvas.addEventListener('mouseup', onMouseUp, false);
		canvas.addEventListener('mouseout', onMouseUp, false);
		canvas.addEventListener('mousemove', throttle(onMouseMove, 10), false);

		//Touch support for mobile devices
		canvas.addEventListener('touchstart', onMouseDown, false);
		canvas.addEventListener('touchend', onMouseUp, false);
		canvas.addEventListener('touchcancel', onMouseUp, false);
		canvas.addEventListener('touchmove', throttle(onMouseMove, 10), false);

		socket.on('drawing', onDrawingEvent);

		window.addEventListener('resize', onResize, false);
		onResize();

		function drawLine(x0, y0, x1, y1, color, emit) {
			context.beginPath();
			context.moveTo(x0, y0);
			context.lineTo(x1, y1);
			context.strokeStyle = color;
			context.lineWidth = 2;
			context.stroke();
			context.closePath();

			if (!emit) { return; }
			var w = canvas.width;
			var h = canvas.height;

			socket.emit('drawing', {
				x0: x0 / w,
				y0: y0 / h,
				x1: x1 / w,
				y1: y1 / h,
				color: color
			},roomNumber);
		}

		function onMouseDown(e) {
			drawing = true;
			current.x = e.clientX || e.touches[0].clientX;
			current.y = e.clientY || e.touches[0].clientY;
		}

		function onMouseUp(e) {
			if (!drawing) { return; }
			drawing = false;
			drawLine(current.x, current.y, e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY, current.color, true);
		}

		function onMouseMove(e) {
			if (!drawing) { return; }
			drawLine(current.x, current.y, e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY, current.color, true);
			current.x = e.clientX || e.touches[0].clientX;
			current.y = e.clientY || e.touches[0].clientY;
		}

		function onColorUpdate(e) {
			current.color = e.target.className.split(' ')[1];
		}

		// limit the number of events per second
		function throttle(callback, delay) {
			var previousCall = new Date().getTime();
			return function () {
				var time = new Date().getTime();

				if ((time - previousCall) >= delay) {
					previousCall = time;
					callback.apply(null, arguments);
				}
			};
		}

		function onDrawingEvent(data) {
			var w = canvas.width;
			var h = canvas.height;
			drawLine(data.x0 * w, data.y0 * h, data.x1 * w, data.y1 * h, data.color);
		}

		// make the canvas fill its parent
		
		function onResize() {
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
		}
		
	</script>
</body>

</html>